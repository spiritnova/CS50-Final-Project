{% extends "layout.html" %}

{% block title %}
Cart
{% endblock %}

{% block main %}
<h1 class="text-white mb-5">Shopping Cart</h1>

<div class="shopping-cart">
<form action="/cart" method="post">
  <div class="column-labels row">
    <h4 class="col-4 text-center">Item Name</h4>
    <h4 class="col-2">Price</h4>
    <h4 class="col-2">Quantity</h4>
    <h4 class="col-2"></h4>
    <h4 class="col-2">Total</h4>
  </div>

  {% for row in rows %}
  <div class="product">
    <div class="row">
      <div class="product-image col-2">
        <img src="/static/Book covers/{{ row["picture"] }}">
      </div>
      <div class="product-details col-2">
        <div class="product-title">{{ row["title"] }}</div>
      </div>
      <div class="product-price col-2">{{ row["price"] }}</div>
      <div class="product-quantity col-2">
        <input type="number" name="quantity" value="1" min="1">
      </div>
      <div class="product-removal col-2">
        <a class="remove-product" href="/cart/remove/{{ row["title"] }}">
          Remove
        </a>
      </div>
      <div class="product-line-price col-2"></div>
    </div>
  </div>
  {% endfor %}

  <div class="totals col-4">
    <div class="totals-item">
      <label class="col-10">Subtotal</label>
      <div class="totals-value" id="cart-subtotal">71.97</div>
    </div>
    <div class="totals-item">
      <label class="col-10">Shipping</label>
      <div class="totals-value" id="cart-shipping">15.00</div>
    </div>
    <div class="totals-item totals-item-total">
      <label class="col-10">Grand Total</label>
      <div class="totals-value" id="cart-total">90.57</div>
    </div>
  </div>

  <button class="checkout">Checkout</button>
</form>
</div>

<script>
  $(".remove-product").on('click', function () {
    $(this).closest('div.product').remove();
  });


//   function getVal(){
//     let quantity = document.querySelector('#quantity').value;
    
//     let price = null

//     {% if rows %}
//     {% for row in rows %}
//       price = JSON.parse('{{ row["price"] | tojson }}');
//       {% endfor %}  
//     {% endif %}

//     if (price !== null)
//     {
//       total = quantity * price;
//       document.querySelector(".product-line-price").innerText = "$" + total;
//     }
//   }

  // Here is where I handle the default value that should be displayed

  let defprice = null

  {% if rows %}
    defprice = JSON.parse('{{ rows[0]["price"] | tojson }}');
  {% endif %}

  
    if (defprice !== null)
    {
      document.querySelector(".product-line-price").innerText = defprice;
    }


/* Set rates + misc */
var shippingRate = 15.00; 
var fadeTime = 300;


/* Assign actions */
$('.product-quantity input').change( function() {
  updateQuantity(this);
});


/* Recalculate cart */
function recalculateCart()
{
  var subtotal = 0;
  
  /* Sum up row totals */
  $('.product').each(function () {
    subtotal += parseFloat($(this).children('.product-line-price').text());
  });

}


/* Update quantity */
function updateQuantity(quantityInput)
{
  /* Calculate line price */
  var productRow = $(quantityInput).parent().parent();
  let price = null
  {% if rows %}
    {% for row in rows %}
      price = JSON.parse('{{ row["price"] | tojson}}');
    {% endfor %}
  {% endif %}
  var quantity = $(quantityInput).val();
  var linePrice = price * quantity;
  
  /* Update line price display and recalc cart totals */
  productRow.children('.product-line-price').each(function () {
    $(this).fadeOut(fadeTime, function() {
      $(this).text(linePrice.toFixed(2));
      recalculateCart();
      $(this).fadeIn(fadeTime);
    });
  });  
}
 </script>

{% endblock %}